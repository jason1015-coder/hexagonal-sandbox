name: Build Executables (Windows .exe, Linux AppImage, macOS)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]
  workflow_dispatch:   # allows manual trigger from Actions tab

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: windows
            artifact: windows-exe
            nuitka-extra: --windows-disable-console --mingw64
            suffix: .exe

          - os: ubuntu-24.04   # good base for AppImage
            target: linux
            artifact: linux-appimage
            nuitka-extra: --linux-onefile --enable-plugin=pyside6,pygame   # ← add your GUI plugins
            suffix: .AppImage   # or just the onefile binary

          - os: macos-latest
            target: macos
            artifact: macos-app
            nuitka-extra: --macos-create-app-bundle --macos-app-name=TesselBox
            suffix: .app.zip

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Add extra deps if needed, e.g. pygame, PySide6/PyQt6, etc.

      - name: Build with Nuitka
        run: |
          python -m nuitka \
            --standalone \
            --onefile \
            --output-dir=dist \
            --include-data-dir=assets=assets \          # ← adjust to your data folders (images, sounds…)
            --include-data-dir=data=data \              # example
            --windows-icon-from-ico=icon.ico \          # if you have one
            ${{ matrix.nuitka-extra }} \
            main.py                                     # ← CHANGE TO YOUR ACTUAL ENTRY POINT (main.py / game.py / tesselbox.py …)

      - name: Prepare Linux AppImage (on Ubuntu only)
        if: matrix.target == 'linux'
        run: |
          # Simple way: rename the onefile to .AppImage (works for many pygame-like apps)
          mv dist/*.bin dist/TesselBox${{ matrix.suffix }} || true
          chmod +x dist/TesselBox${{ matrix.suffix }}
          # More advanced → use appimage-builder or linuxdeploy later if needed

      - name: Prepare macOS .app zip
        if: matrix.target == 'macos'
        run: |
          cd dist
          zip -r TesselBox${{ matrix.suffix }} TesselBox.app
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tesselbox-${{ matrix.artifact }}
          path: dist/*${{ matrix.suffix }}
          retention-days: 14

  # Optional: Attach binaries to GitHub Release when you create a tag (v1.0.0 etc.)
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            tesselbox-*/**/*
          draft: true   # change to false when ready
